
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserData() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user is Manager or Admin
    function isManager() {
        return isAuthenticated() && (
            getUserData().role == 'Manager' ||
            getUserData().role == 'Admin'
        );
    }

    // Check if user account is Active (Approved)
    function isActive() {
        return isAuthenticated() && getUserData().status == 'Active';
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Allow specific get for profiles
      allow get: if isAuthenticated();
      // Allow list for everyone (directory) or Badge Login
      allow list: if isAuthenticated() || request.query.limit <= 1;
      allow create: if isAuthenticated(); 
      
      allow update: if isAuthenticated() && (
          isManager() || 
          (isOwner(userId) && 
           request.resource.data.role == resource.data.role &&
           request.resource.data.status == resource.data.status &&
           request.resource.data.employeeId == resource.data.employeeId
          )
      );
      
      match /cpd/{entry} {
        allow read, write: if isAuthenticated() && (isOwner(userId) || isManager());
      }

      match /notifications/{notifId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow create: if isManager() || isOwner(userId);
        allow update: if isAuthenticated() && isOwner(userId);
      }
    }

    // --- Rota Unavailability ---
    match /unavailability/{docId} {
      allow read: if isAuthenticated() && (isManager() || resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && (isManager() || resource.data.userId == request.auth.uid);
    }

    // --- ePRFs (Clinical Records) ---
    match /eprfs/{document} {
      allow create: if isAuthenticated();
      
      // Read: Access List members OR Managers OR Active Staff (Spine Search)
      // We allow any Active staff member to read (query) records to support patient history lookup (Spine Search).
      // Confidentiality is enforced via UI flows and Audit Logging.
      allow read: if isAuthenticated() && (
          request.auth.uid in resource.data.accessUids || 
          isManager() ||
          isActive()
      );
      
      // Update: 
      // 1. Must be in access list or Manager
      // 2. STRICT: CANNOT update if status is 'Submitted'. Once submitted, it is locked for everyone.
      allow update: if isAuthenticated() && (request.auth.uid in resource.data.accessUids || isManager()) 
                    && resource.data.status != 'Submitted';
      
      // Delete: Only if NOT Submitted (Drafts only)
      allow delete: if isAuthenticated() && (request.auth.uid in resource.data.accessUids || isManager())
                    && resource.data.status != 'Submitted';
    }

    // --- Rota & Shifts ---
    match /shifts/{shiftId} {
      allow read: if isAuthenticated();
      allow create, delete: if isManager();
      allow update: if isManager() || (
        isAuthenticated() && 
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['slots', 'timeRecords']))
      );
    }

    // --- Assets (Fleet & Kits) ---
    match /fleet/{vehicle} {
      allow read: if isAuthenticated();
      allow write: if isManager(); // Fixes "Error adding asset"
      allow update: if isAuthenticated(); // Allow staff to update status via VDI
    }
    
    match /medical_kits/{kit} {
      allow read: if isAuthenticated();
      allow write: if isManager(); // Fixes "Error adding asset"
      allow update: if isAuthenticated();
    }
    
    match /asset_checks/{check} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }
    
    // --- Drugs & Stock ---
    match /stock/{item} {
      allow read: if isAuthenticated();
      allow update: if isAuthenticated();
    }
    
    match /drug_audit/{entry} {
      allow read: if isManager();
      allow create: if isAuthenticated();
      allow update, delete: if false; 
    }

    // --- System / Communication ---
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); 
    }
    
    match /announcements/{id} {
      allow read: if isAuthenticated();
      allow write: if isManager();
    }
    
    match /kudos/{id} {
      allow read, create: if isAuthenticated();
    }
    
    match /feedback/{id} {
      allow create: if isAuthenticated();
      allow read: if isManager();
    }
    
    match /oh_referrals/{id} {
      allow create: if isAuthenticated();
      allow read: if isManager() || request.auth.uid == resource.data.userId;
    }
    
    match /major_incident_logs/{id} {
      allow read, create: if isAuthenticated();
    }
    
    match /audit_logs/{id} {
        allow create: if isAuthenticated();
        allow read: if isManager();
        allow update, delete: if false;
    }

    match /documents/{docId} {
      allow read: if isAuthenticated();
      allow write: if isManager();
    }
  }
}
